<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-zinc-950"></body>
<!-- markdown view skining -->
<style>
  markdown-view {
    --h1: #A6F;
    --h2: #893;
    --code-sm: #88E;
    --code: #ABC;
    --info-bg: #222;
    --info-text: #888;
    --link: #56A;
    --hover-link: #78F;
    --scroll-bg: #131313;
    --scroll-tumb: #222;
    --scroll-hover: #89a15d;
  }

  ::-webkit-scrollbar { width: 1rem; }
  ::-webkit-scrollbar-track { background: var(--scroll-bg) }
  ::-webkit-scrollbar-thumb { background: var(--scroll-tumb) }
  ::-webkit-scrollbar-thumb:hover { background: var(--scroll-hover)}

  pre {
    scrollbar-width: thin;
    scrollbar-color: #111 #333!important;
  }

  sw {color:#fb8600}
  rw {color:#acd641}
  bw {color:#ac84d7}
  ew {color:#ac84d7}
  uw {color:#8f665f}
  st {color:#2fd57f}
  rm {color:#768d76}
  jd {color:#9ea77d}
  wt {color:#618be3}

</style>
<script src="old-bird-soft.js" type="module"></script>
<main class="min-h-screen bg-zinc-950 text-zinc-400">
  <section class="max-w-screen-2xl m-auto grid grid-cols-1 gap-2 lg:grid-cols-2">
    <textarea
    class="bg-zinc-800 text-zinc-400 focus:outline-none p-8 placeholder-zinc-600"
    placeholder=" - - - markdown editor - - - "
    spellcheck="false"
    ></textarea>

    <article class="bg-zinc-900 whitespace-pre-wrap px-8
      min-w-full min-h-screen
    ">
      <markdown-view source="textarea" />
    </article>
  </section>

  <!-- markdown components -->
  <template id="code-block">
    <pre class="bg-zinc-950 p-4 text-lime-200 overflow-x-scroll"><slot></slot></pre>
  </template>
  <template class="head-1">
    <h1 class="text-orange-200 text-[2rem]"><slot></slot></h1>
  </template>
  <template class="head-2">
    <h2 class="text-orange-400 text-xl"><slot></slot></h2>
  </template>
  <template class="s-italic">
    <em><slot></slot></em>
  </template>
  <template id="info-block">
    <p class="bg-zinc-950 p-4 rounded"><slot></slot></p>
  </template>
  <!-- Check it: <a class="underline text-emerald-400" href="https://github.com/mundimark/awesome-markdown-editors?tab=readme-ov-file" target="_blank">markdown-ediotor-collections</a> -->
</main>

<script type="module">
  /**
   * https://mateam.net/html-escape-characters/
   *
   * @type {(str:string) => string}
   */
  const encodCodeBlockToSafeHtml = str => str
    .replaceAll(/[\&|<|>|\\|']/g,
    specialCharacter => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "\\": "&#92",
      "'": "&apos;",
      "`": "&#96",
      "|": "|"
    }[specialCharacter]));

  globalThis.safeEncode = encodCodeBlockToSafeHtml;

  /** @type {(safeCode:string) => string} */
  const syntaxHighlight = safeCode => {
    return encodCodeBlockToSafeHtml(safeCode)
      .replaceAll(/("[^&]*"|`[^&]*`|&apos;[^&]*&apos;)/g, "<st>$1</st>")
      .replaceAll(/(&lt;[^\s|^&]*&gt;)/g, "<wt>$1</wt>")
      .replaceAll(/(&lt;[^\s|^&|^\!]*)(\s+)/g, "<wt>$1</wt>$2")
      .replaceAll(/(\/&gt;)/g, "<wt>$1</wt>")
      .replaceAll(/(\{|\}|\(|\)|\[|\])/g, "<sw>$1</sw>")
      .replaceAll(/(\s*|\n*)(const|let|return|function|var|for|if|while|\?|\:)(\s+|\n+)/g, "$1<rw>$2</rw>$3")
      .replaceAll(/(\s*|\n*)(className|class|onClick|onInput|export|import|@type|@typedef|string|number|object|false|true)(\s+|\n+|\=)/g, "$1<ew>$2</ew>$3")
      .replaceAll(/(\=&gt;|\=|\|)/g, "<uw>$1</uw>")
      .replaceAll(/(\/\/(.*)$)/g, "<rm>$1</rm>") // .replaceAll(/(\<([^\>|^rm]*)\>)/g,"")
      .replaceAll(/(\/\*\*[^\*|.]*\*\/)/g, "<jd>$1</jd>")
      .replaceAll(/(&lt;\!--[.|^&]*--&gt;)/g, "<rm>$1</rm>")
    ;
  }

  const inlineMarkdown = str => encodCodeBlockToSafeHtml(str)
    .replaceAll(/`([^`]*)`/g, `<span class="text-[--code-sm]">$1</span>`)
    .replaceAll(/\[([^\]]+)\]\(([^\)].+)\)/g,`<a class="
       transition-all
       duration-500
       text-white
       hover:text-sky-400
       hover:bg-sky-800
       p-2 rounded"
       href="$2"
      target="_blank">$1</a>
    `)

  /**
   * Very Earluy POC level Parser
   * @type {(source:string) => string}
   */
  const markdownParser = (source) => {
    let codeBlock = false;
    const CR = '\n';
    const lines = source.split(CR);
    return lines.map(
      line => {
        if (codeBlock) switch (true) {
            case /^\s*```/.test(line):
              codeBlock = false;
              return '</pre>'
            default: return syntaxHighlight(line);
          }

        if (!codeBlock) switch (true) {
          case /^\s*```/.test(line):
            codeBlock = true;
            return '<pre class="bg-zinc-950 p-4 text-emerald-200 overflow-x-scroll">'
          case /^\s*#\s/.test(line):
            return `<h1 class="text-orange-200 text-[2rem]">${inlineMarkdown(
              line.slice(line.indexOf('#') + 2 ?? 0)
            )}</h1>`;
          case /^\s*#+\s/.test(line):
            return `<h2 class="text-orange-400 text-xl">${inlineMarkdown(
              line.slice(line.indexOf('#') + 2 ?? 0)
            )}</h2>`;
          case /^\s*_[^_]+_/.test(line):
            return `<em>${inlineMarkdown(
              line.replaceAll('_', '')
            )}</em>`;
          case /^\s*>\s/.test(line):
            return `<p class="bg-zinc-950 p-4 rounded">${inlineMarkdown(
              line.replace('>','')
            )}</p>`;
          case /^\s*\!\[.*\]\(.*\)\s/.test(line):
            return `<picture>- image - placeholder -</picture>`;
          default:
            return inlineMarkdown(line);
        }
      }
    )
    .join(CR);
  }

  customElements.define('markdown-view', class extends HTMLElement {
    constructor () {
      super();
      const source = document.querySelector('textarea').value;
      globalThis.so = source;
      this.innerHTML = markdownParser(source);
    }

    changeContent (source) {
      this.innerHTML = markdownParser(source);
    }
  });

  const markdownView = document.querySelector('markdown-view');
  const markdownEditor = document.querySelector('textarea');

  fetch('./demo.md').then(r=>r.text()).then(md => markdownView.changeContent(md))

  markdownEditor.addEventListener("input", e => {
    e.stopPropagation();
    markdownView.changeContent(e?.target?.value);
  })

  // Animation test over markdown editor

  const spriteSheet =
  [4, 26, 50, 74, 96].map((horizontal) =>
    [4, 36, 69, 103].map((vertical) => `${horizontal}% ${vertical}%`)
  ).flat();

  import { fragment } from './old-bird-soft.js';

  const anim = [
    { transform: "translateX(%0)" },
    { transform: "rotate(0) translate3D(-50%, -50%, 0)" },
    // { backgroundColor: "#431236", offset: 0.3 },
    { transform: "rotate(360deg) translate3D(-50%, -50%, 0)" },
    { transform: "translateX(%80)" },
  ]
  const timeline = {
    duration: 2000,
    iterations: Infinity
  }

  const rnd = range => Math.random() * range | 0;

  globalThis.startStop = () => {
    // if (an2.playState == 'running') {
    const actor = fragment('#card', 'body', 'card-02', 'figure')
    actor.style.top=`${rnd(55)}rem`;
    actor.style.left=`${rnd(70)}rem`;
    actor.style.transform=`scale(${Math.random()})`;
    actor.style.backgroundPosition = spriteSheet[rnd(spriteSheet.length)];
    // actor.addEventListener("click", () => {actor.pause()});
    // style don't work any more.
    actor.animate(anim, timeline);
    actor.playbackRate = rnd(5000);
    actor.play();
  }
</script>

<section class="fixed bottom-16 left-16 hidden">
  <button class="p-2 bg-sky-600 text-sky-200 m-2 rounded-full" onclick="globalThis.startStop()">card +</button>
</section>
