<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-zinc-950"></body>

<main class="bg-zinc-800 text-zinc-400 p-8 min-h-screen">
  <h1 class="text-orange-400 text-xl">Three Match Game</h1>

  <template id="frag">
    <figure
      class="
        fixed
        top-[5rem]
        left-[2rem]
        w-[6rem]
        h-[6rem]
        bg-[url(../sprites/potter3m.png)]
        bg-[length:660%]
        --bg-[position:23.5%_26.7%]
        --bg-[position:42.5%_26.7%]
        --bg-[position:42.5%_36.4%]
        rounded-xl
        transition-all
        duration-1000
        hover:opacity-30
        hover:duration-200
      "
    >
      <span class="text-emerald-200 text-4xl bg-black/40 p-2 m-2"></span>
    </figure>
  </template>

  <img
    src="../sprites/potter3m.png"
    alt=""
    class="w-96 fixed right-0 top-0 opacity-35"
  />
</main>

<script type="module">
  import { fragment, delay } from "./old-bird-soft.js";

  const rnd = (range) => (Math.random() * range) | 0;

  const spriteSheet = [4.5, 23.5, 62, 81, 100]
    .map((horizontal) =>
      [7, 17, 27, 36.4, 46, 56, 65.5, 75.2, 85].map(
        (vertical) => `${horizontal}% ${vertical}%`,
      ),
    )
    .flat();

  const fragFactory = (id, spriteIndex, x = 0, y = 0) => {
    const actor = fragment("#frag", "body", id, "figure");
    actor.style.backgroundPosition = spriteSheet[spriteIndex];
    actor.style.top = `${y}rem`;
    actor.style.left = `${x}rem`;
    return actor;
  };

  const state = Array(6 * 8)
    .fill(0)
    .map((_) => rnd(3) + 12);

  const view = state.map((tag, index) => {
    /** @type {HTMLElement} */
    const frg = fragFactory(
      "frg_" + index,
      tag,
      (index % 6) * 6.4 + 2,
      // (index / 6 | 0 ) * 6.4 + 5
      -20,
    );
    frg.onclick = async (e) => {
      frg.style.zIndex = 100;
      delay(10);
      e.target.style.top = "100vh";
    };
    const log = (info) => (frg.children[0].innerText = info);
    // log(tag);
    setTimeout(() => {
      frg.style.top = `${((index / 6) | 0) * 6.4 + 5}rem`;
    }, rnd(3000));
    return { index, frg, tag, log };
  });

  // let line = "2,3,4,5,5,5,3,7,7,7,5,5,5,2";
  // let {0:fo, 1:nu, index} = /(\b\d+\b)(?:,\1){2,}/g.exec(line);

  const findMatch = (line) => {
    let { 0: fo, 1: nu, index } = /(\b\d+\b)(?:,\1){2,}/g.exec(line) ?? {};
    const score = fo?.split(",")?.length;
    return score
      ? {
          nu: +nu,
          score,
          idx: index / (nu.length + 1),
          list: range(index, index + score),
        }
      : null;
  };

  const maxX = 6;
  const maxY = 8;

  /** @type {(start:number, end:number) => number[]} */
  const range = (start, end) =>
    Array(end - start)
      .fill()
      .map((_, idx) => idx + start);

  let pattern = [];

  // horizontal find
  range(0, maxY).forEach((idx) => {
    const start = idx * maxX;
    const line = state.slice(start, start + maxX).join();
    const find = findMatch(line);
    if (find) {
      find.pos = find.list.map(m => m + (start));
      find.ff  = start;
      pattern.push(find);
      console.log(line + "::" + JSON.stringify(find));
    }
  });

  console.log("--------");

  // vertical find
  range(0, maxX).forEach((idx) => {
    const line = range(0, maxY).map((collumn) => state[collumn * maxX + idx]);
    const find = findMatch(line);
    if (find) {
      //find.pos = find.list.map(m => m + (idx * maxX)); 
      pattern.push(find);
      console.log(line + "::" + JSON.stringify(find));
    }
  });

  // console.log(pattern);

  const matchList = new Set(
    pattern.map(({pos}) => pos)
    .flat()
    .sort((a,b) => a - b)
  );

  console.log(matchList)


  state.forEach((nu, idx) => view[idx].log(
    matchList.has(idx) 
      ? `(${nu})`
      : nu
  ));

  globalThis.state = state;
  globalThis.view = view;
</script>
